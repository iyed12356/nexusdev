{% extends 'base_player.html.twig' %}

{% block title %}Browse Players - Team Recruitment{% endblock %}

{% block body %}
<section class="np-section">
    <div class="container">
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="np-section-title">üîç Find Players for {{ team.name }}</h1>
                <p class="np-text-muted">Search and recruit talented players to join your team.</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{{ path('app_player_dashboard', {'id': app.user.player.id}) }}" class="btn btn-secondary">
                    ‚Üê Back to Dashboard
                </a>
            </div>
        </div>

        {# Search Form #}
        <div class="np-card mb-4" style="padding: 1.5rem;">
            <form method="get" class="row g-3">
                <div class="col-md-8">
                    <input type="text" name="search" class="form-control" 
                           placeholder="Search by player nickname..." 
                           value="{{ search }}">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">üîç Search</button>
                </div>
            </form>
        </div>

        {# Players Grid #}
        {% if players|length > 0 %}
            <div class="row">
                {% for player in players %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="np-card" style="padding: 1.5rem; height: 100%;">
                            <div class="d-flex align-items-center mb-3">
                                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #4a9eff, #6b5ce7); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 1rem;">
                                    {{ player.nickname|first|upper }}
                                </div>
                                <div>
                                    <h5 class="mb-1">{{ player.nickname }}</h5>
                                    {% if player.game %}
                                        <span class="badge bg-primary">{{ player.game.name }}</span>
                                    {% endif %}
                                    {% if player.isPro %}
                                        <span class="badge bg-warning text-dark">PRO</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-3">
                                {% if player.role %}
                                    <p class="mb-1"><strong>Role:</strong> {{ player.role }}</p>
                                {% endif %}
                                {% if player.nationality %}
                                    <p class="mb-1"><strong>Nationality:</strong> {{ player.nationality }}</p>
                                {% endif %}
                                {% if player.score is not null %}
                                    <p class="mb-1"><strong>Score:</strong> {{ player.score }}</p>
                                {% endif %}
                                <p class="mb-0"><strong>Rank:</strong> <span class="text-primary">{{ player.getRank()|default('Unranked') }}</span></p>
                            </div>

                            <div class="mt-auto">
                                {% if player.id in invitedPlayerIds %}
                                    <button class="btn btn-secondary w-100" disabled>
                                        ‚úì Invitation Sent
                                    </button>
                                {% else %}
                                    <button class="btn btn-primary w-100" onclick="showInviteModal({{ player.id }}, '{{ player.nickname|e('js') }}')">
                                        üì® Send Invitation
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="np-card text-center" style="padding: 3rem;">
                <h3>üòï No players found</h3>
                <p class="np-text-muted">Try adjusting your search criteria.</p>
            </div>
        {% endif %}
    </div>
</section>

{# Invitation Modal #}
<div class="modal fade" id="inviteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--np-card-bg); border: 1px solid var(--np-border);">
            <div class="modal-header">
                <h5 class="modal-title">üì® Send Team Invitation</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Invite <strong id="playerName"></strong> to join <strong>{{ team.name }}</strong>!</p>
                <div class="mb-3">
                    <label for="inviteMessage" class="form-label">Personal Message (optional):</label>
                    <textarea id="inviteMessage" class="form-control" rows="3" 
                              placeholder="Hey! We'd love to have you on our team..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendInviteBtn" onclick="sendInvitation()">
                    Send Invitation
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedPlayerId = null;

function showInviteModal(playerId, playerName) {
    selectedPlayerId = playerId;
    document.getElementById('playerName').textContent = playerName;
    document.getElementById('inviteMessage').value = '';
    new bootstrap.Modal(document.getElementById('inviteModal')).show();
}

function sendInvitation() {
    const message = document.getElementById('inviteMessage').value;
    const btn = document.getElementById('sendInviteBtn');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';

    fetch(`{{ path('app_team_invite_player', {'playerId': 'PLAYER_ID'}) }}`.replace('PLAYER_ID', selectedPlayerId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: 'message=' + encodeURIComponent(message)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('inviteModal')).hide();
            
            // Show success toast
            const toast = document.createElement('div');
            toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
            toast.style.zIndex = '9999';
            toast.innerHTML = data.message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
                location.reload();
            }, 2000);
        } else {
            alert(data.error || 'Failed to send invitation');
            btn.disabled = false;
            btn.innerHTML = 'Send Invitation';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while sending the invitation.');
        btn.disabled = false;
        btn.innerHTML = 'Send Invitation';
    });
}
</script>
{% endblock %}
