{% extends 'back/base.html.twig' %}

{% block title %}Comments{% endblock %}

{% block admin_content %}
    <section class="np-section np-animate-in">
        <div class="np-section-header">
            <span class="np-section-kicker">Back office</span>
            <h1 class="np-section-title">Comments</h1>
            <p class="np-section-subtitle">Manage comments from Forum Posts and Content/Guides.</p>
        </div>

        <div class="np-back-layout">
            <div class="np-back-layout-main">
                <h2 class="np-section-title mb-3">All Comments</h2>
                
                {# Tabs #}
                <div class="mb-4">
                    <a href="{{ path('app_comments_back', {'tab': 'forum'}) }}" 
                       class="btn btn-sm {{ current_tab == 'forum' ? 'btn-primary' : 'btn-outline-primary' }}">
                        <i class="bi bi-chat-dots me-1"></i> Forum ({{ forumComments|length }})
                    </a>
                    <a href="{{ path('app_comments_back', {'tab': 'content'}) }}" 
                       class="btn btn-sm {{ current_tab == 'content' ? 'btn-primary' : 'btn-outline-primary' }}">
                        <i class="bi bi-file-text me-1"></i> Content ({{ contentComments|length }})
                    </a>
                </div>

                <div class="np-card p-0 overflow-hidden">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th class="px-4 py-3" style="width: 60px;">#</th>
                                    <th class="px-4 py-3">Comment</th>
                                    <th class="px-4 py-3">Author</th>
                                    <th class="px-4 py-3">On {{ current_tab == 'forum' ? 'Post' : 'Content' }}</th>
                                    <th class="px-4 py-3">Created</th>
                                    <th class="px-4 py-3 text-end" style="width: 180px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% if current_tab == 'forum' %}
                                {% for reponse in forumComments %}
                                <tr class="align-middle">
                                    <td class="px-4 fw-semibold text-muted">{{ reponse.id }}</td>
                                    <td class="px-4">
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="bi bi-chat-text text-info"></i>
                                            <span>{{ reponse.content|slice(0, 50) }}{% if reponse.content|length > 50 %}...{% endif %}</span>
                                        </div>
                                    </td>
                                    <td class="px-4">
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="np-avatar-sm" style="width: 28px; height: 28px; background: linear-gradient(135deg, #ec4899, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.65rem; font-weight: 600;">
                                                {{ reponse.author.username|slice(0, 2)|upper }}
                                            </div>
                                            <span class="text-muted">{{ reponse.author.username }}</span>
                                        </div>
                                    </td>
                                    <td class="px-4">
                                        <span class="badge bg-secondary">{{ reponse.post.title|slice(0, 30) }}{% if reponse.post.title|length > 30 %}...{% endif %}</span>
                                    </td>
                                    <td class="px-4 text-muted">{{ reponse.createdAt|date('M d, Y') }}</td>
                                    <td class="px-4 text-end">
                                        <div class="d-flex gap-2 justify-content-end">
                                            <button type="button" class="btn btn-sm btn-warning d-flex align-items-center gap-1" data-bs-toggle="modal" data-bs-target="#editReponseModal{{ reponse.id }}" title="Edit">
                                                <i class="bi bi-pencil-square"></i><span>Edit</span>
                                            </button>
                                            <a href="{{ path('app_forum_post_back', {'id': reponse.post.id}) }}" class="btn btn-sm btn-info d-flex align-items-center gap-1" title="View Post"><i class="bi bi-eye"></i><span>View</span></a>
                                            <form method="post" action="{{ path('app_reponse_delete', {'id': reponse.id}) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ reponse.id) }}">
                                                <button class="btn btn-sm btn-danger d-flex align-items-center gap-1" title="Delete"><i class="bi bi-trash"></i><span>Delete</span></button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-5 text-muted">
                                        <i class="bi bi-chat-dots display-4 mb-3 d-block"></i>
                                        <p class="mb-0">No forum comments found.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                {% for comment in contentComments %}
                                <tr class="align-middle">
                                    <td class="px-4 fw-semibold text-muted">{{ comment.id }}</td>
                                    <td class="px-4">
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="bi bi-chat-text text-success"></i>
                                            <span>{{ comment.content|slice(0, 50) }}{% if comment.content|length > 50 %}...{% endif %}</span>
                                        </div>
                                    </td>
                                    <td class="px-4">
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="np-avatar-sm" style="width: 28px; height: 28px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.65rem; font-weight: 600;">
                                                {{ comment.author.username|slice(0, 2)|upper }}
                                            </div>
                                            <span class="text-muted">{{ comment.author.username }}</span>
                                        </div>
                                    </td>
                                    <td class="px-4">
                                        {% if comment.guide %}
                                            <span class="badge bg-secondary">{{ comment.guide.title|slice(0, 30) }}{% if comment.guide.title|length > 30 %}...{% endif %}</span>
                                        {% else %}
                                            <span class="badge bg-danger">Deleted</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 text-muted">{{ comment.createdAt|date('M d, Y') }}</td>
                                    <td class="px-4 text-end">
                                        <div class="d-flex gap-2 justify-content-end">
                                            <button type="button" class="btn btn-sm btn-warning d-flex align-items-center gap-1" data-bs-toggle="modal" data-bs-target="#editCommentModal{{ comment.id }}" title="Edit">
                                                <i class="bi bi-pencil-square"></i><span>Edit</span>
                                            </button>
                                            {% if comment.guide %}
                                            <a href="{{ path('app_content_back', {'id': comment.guide.id}) }}" class="btn btn-sm btn-info d-flex align-items-center gap-1" title="View Content"><i class="bi bi-eye"></i><span>View</span></a>
                                            {% endif %}
                                            <form method="post" action="{{ path('app_comment_delete', {'id': comment.id}) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this comment?');">
                                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ comment.id) }}">
                                                <button class="btn btn-sm btn-danger d-flex align-items-center gap-1" title="Delete"><i class="bi bi-trash"></i><span>Delete</span></button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-5 text-muted">
                                        <i class="bi bi-file-text display-4 mb-3 d-block"></i>
                                        <p class="mb-0">No content comments found.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="np-back-layout-side">
                <div class="np-form-card np-animate-in-delayed">
                    <h2 class="np-section-title">Add New Comment</h2>
                    
                    <form method="post" action="{{ path('app_comment_add') }}" class="np-form">
                        <div class="mb-3">
                            <label class="form-label">Comment Type:</label>
                            <select name="type" class="form-control" required>
                                <option value="forum">Forum Post Comment</option>
                                <option value="content">Content/Guide Comment</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Post/Content ID:</label>
                            <input type="number" name="target_id" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Comment:</label>
                            <textarea name="content" class="form-control" rows="4" required></textarea>
                        </div>
                        <button class="btn btn-success">Save Comment</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    {# Edit Modals for Forum Comments #}
    {% for reponse in forumComments %}
    <div class="modal fade" id="editReponseModal{{ reponse.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: #0f172a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;">
                <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <h5 class="modal-title" style="color: #f8fafc; font-weight: 600;">Edit Forum Comment #{{ reponse.id }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{{ path('app_reponse_edit', {'id': reponse.id}) }}">
                    <div class="modal-body" style="padding: 20px;">
                        <div class="mb-3">
                            <label class="form-label" style="color: #94a3b8; font-size: 0.9rem;">On Post:</label>
                            <p style="color: #60a5fa; margin: 0;">{{ reponse.post.title }}</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" style="color: #94a3b8; font-size: 0.9rem;">Author: {{ reponse.author.username }}</label>
                        </div>
                        <textarea name="content" class="form-control" style="background: #1e293b; color: #f8fafc; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 12px;" rows="4">{{ reponse.content }}</textarea>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1); padding: 16px 20px;">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-color: rgba(255,255,255,0.2); color: #94a3b8;">Cancel</button>
                        <button type="submit" class="btn btn-primary" style="background: #3b82f6; border: none; padding: 8px 20px;">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}

    {# Edit Modals for Content Comments #}
    {% for comment in contentComments %}
    <div class="modal fade" id="editCommentModal{{ comment.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: #0f172a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;">
                <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <h5 class="modal-title" style="color: #f8fafc; font-weight: 600;">Edit Content Comment #{{ comment.id }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{{ path('app_comment_edit', {'id': comment.id}) }}">
                    <div class="modal-body" style="padding: 20px;">
                        <div class="mb-3">
                            <label class="form-label" style="color: #94a3b8; font-size: 0.9rem;">On Content:</label>
                            <p style="color: #60a5fa; margin: 0;">{{ comment.guide ? comment.guide.title : 'Deleted content' }}</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" style="color: #94a3b8; font-size: 0.9rem;">Author: {{ comment.author.username }}</label>
                        </div>
                        <textarea name="content" class="form-control" style="background: #1e293b; color: #f8fafc; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 12px;" rows="4">{{ comment.content }}</textarea>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1); padding: 16px 20px;">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-color: rgba(255,255,255,0.2); color: #94a3b8;">Cancel</button>
                        <button type="submit" class="btn btn-primary" style="background: #3b82f6; border: none; padding: 8px 20px;">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
{% endblock %}

