{% extends 'analytics/index.html.twig' %}

{% block title %}{{ player.nickname }} - Performance Analytics{% endblock %}

{% block analytics_content %}
{# Player Header #}
<div class="np-hero mb-4">
    <div class="np-hero-text">
        <div class="d-flex align-items-center gap-3 mb-3">
            {% if player.profilePicture %}
                <img src="{{ asset('uploads/' ~ player.profilePicture) }}" alt="{{ player.nickname }}" class="np-avatar np-avatar--xl np-avatar--bordered">
            {% else %}
                <div class="np-avatar np-avatar--xl np-avatar--bordered">{{ player.nickname|first|upper }}</div>
            {% endif %}
            <div>
                <h1 class="m-0" style="font-size: 2.5rem; font-weight: 800;">{{ player.nickname }}</h1>
                <p class="text-muted mt-1 mb-0">
                    {{ player.game.name }} • {{ player.role|default('No Role') }}
                    {% if player.team %}
                        • {{ player.team.name }}
                    {% endif %}
                </p>
                <div class="d-flex gap-2 mt-2">
                    <span class="tier-badge tier-badge--{{ currentTier|lower }}">{{ currentTier }}</span>
                    <span class="font-weight-bold" style="font-family: monospace; font-size: 1.2rem;">{{ latestElo }} ELO</span>
                </div>
            </div>
        </div>
    </div>
</div>

{# Export Button #}
<div style="margin-bottom: 1.5rem; text-align: right;">
    <a href="{{ path('app_analytics_export', {'playerId': player.id, 'format': 'csv', 'game': game.id}) }}" class="btn btn-secondary">
        <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 0.5rem;">
            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
        </svg>
        Export Stats (CSV)
    </a>
</div>

{# Stats Overview #}
<div class="row mb-4">
    <div class="col-md-2 col-6">
        <div class="np-stat-card np-stat-card--white">
            <div class="np-stat-card__label">Matches Played</div>
            <div class="np-stat-card__value">{{ playerStat ? playerStat.matchesPlayed : 0 }}</div>
        </div>
    </div>
    <div class="col-md-2 col-6">
        <div class="np-stat-card np-stat-card--green">
            <div class="np-stat-card__label">Wins</div>
            <div class="np-stat-card__value">{{ playerStat ? playerStat.wins : 0 }}</div>
        </div>
    </div>
    <div class="col-md-2 col-6">
        <div class="np-stat-card np-stat-card--cyan">
            <div class="np-stat-card__label">Win Rate</div>
            <div class="np-stat-card__value">{{ playerStat ? playerStat.winRate : 0 }}%</div>
        </div>
    </div>
    <div class="col-md-2 col-6">
        <div class="np-stat-card np-stat-card--amber">
            <div class="np-stat-card__label">K/D Ratio</div>
            <div class="np-stat-card__value">
                {% if playerStat and playerStat.deaths > 0 %}
                    {{ (playerStat.kills / playerStat.deaths)|number_format(2) }}
                {% elseif playerStat %}
                    {{ playerStat.kills }}
                {% else %}0{% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-2 col-6">
        <div class="np-stat-card np-stat-card--red">
            <div class="np-stat-card__label">Total Kills</div>
            <div class="np-stat-card__value">{{ playerStat ? playerStat.kills : 0 }}</div>
        </div>
    </div>
    <div class="col-md-2 col-6">
        <div class="np-stat-card np-stat-card--purple">
            <div class="np-stat-card__label">KDA</div>
            <div class="np-stat-card__value">
                {% if playerStat and playerStat.deaths > 0 %}
                    {{ ((playerStat.kills + playerStat.assists) / playerStat.deaths)|number_format(2) }}
                {% elseif playerStat %}
                    {{ playerStat.kills + playerStat.assists }}
                {% else %}0{% endif %}
            </div>
        </div>
    </div>
</div>

{# Team Statistics - only show if player has a team #}
{% if player.team %}
<div class="np-card mb-4">
    <div class="np-card__header">
        <h3 class="np-card__title"><span class="text-muted">Team:</span> {{ player.team.name }}</h3>
        <a href="{{ path('app_analytics_team_synergy', {'teamId': player.team.id, 'game': game.id}) }}" class="btn btn-sm btn-secondary">View Team Details</a>
    </div>
    
    {% if teamStats is defined and teamStats %}
    <div class="np-card__body">
        <div class="row">
            <div class="col-md-3 col-6">
                <div class="np-stat-card np-stat-card--white">
                    <div class="np-stat-card__label">Team Matches</div>
                    <div class="np-stat-card__value">{{ teamStats.matchesPlayed|default(0) }}</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="np-stat-card np-stat-card--green">
                    <div class="np-stat-card__label">Team Wins</div>
                    <div class="np-stat-card__value">{{ teamStats.wins|default(0) }}</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="np-stat-card np-stat-card--cyan">
                    <div class="np-stat-card__label">Win Rate</div>
                    <div class="np-stat-card__value">{{ teamStats.winRate|default(0) }}%</div>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="np-stat-card np-stat-card--purple">
                    <div class="np-stat-card__label">Players</div>
                    <div class="np-stat-card__value">{{ teamStats.playerCount|default(0) }}</div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="np-card__body">
        <p class="text-muted m-0">Team statistics available on team detail page.</p>
    </div>
    {% endif %}
</div>
{% endif %}

{# Charts Row - only show if there's data #}
{% if chartData|length > 1 or monthlyStats.totalMatches|default(0) > 0 %}
<div class="row mb-4">
    {% if chartData|length > 1 %}
    <div class="col-md-6">
        <div class="np-card np-card--stats">
            <div class="np-card__header">
                <h3 class="np-card__title">ELO Rating History</h3>
            </div>
            <div class="np-card__body">
                <canvas id="eloChart" height="250"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
    {% if monthlyStats.totalMatches|default(0) > 0 %}
    <div class="col-md-6">
        <div class="np-card np-card--stats">
            <div class="np-card__header">
                <h3 class="np-card__title">Performance Trends (Last 90 Days)</h3>
            </div>
            <div class="np-card__body">
                <div id="trendsChartContainer">
                    <canvas id="trendsChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

{# Recent Matches - only show if there are matches #}
{% if recentMatches|length > 0 %}
<div class="np-card np-card--stats">
    <div class="np-card__header">
        <h3 class="np-card__title">Recent Matches</h3>
    </div>
    <div class="table-responsive">
        <table class="leaderboard-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Map</th>
                    <th>Kills</th>
                    <th>Deaths</th>
                    <th>Assists</th>
                    <th>KDA</th>
                    <th>Result</th>
                    <th>ELO Change</th>
                </tr>
            </thead>
            <tbody>
                {% for match in recentMatches %}
                    {% set matchPlayer = null %}
                    {% for mp in match.matchPlayers %}
                        {% if mp.player.id == player.id %}
                            {% set matchPlayer = mp %}
                        {% endif %}
                    {% endfor %}
                    {% if matchPlayer %}
                    <tr>
                        <td>{{ match.matchDate ? match.matchDate|date('M d, Y') : 'N/A' }}</td>
                        <td>{{ match.map|default('Unknown') }}</td>
                        <td>{{ matchPlayer.kills }}</td>
                        <td>{{ matchPlayer.deaths }}</td>
                        <td>{{ matchPlayer.assists }}</td>
                        <td>
                            {% if matchPlayer.deaths > 0 %}
                                {{ ((matchPlayer.kills + matchPlayer.assists) / matchPlayer.deaths)|number_format(2) }}
                            {% else %}
                                {{ matchPlayer.kills + matchPlayer.assists }}
                            {% endif %}
                        </td>
                        <td>
                            {% if matchPlayer.isWinner %}
                                <span class="text-success font-weight-semibold">Win</span>
                            {% else %}
                                <span class="text-danger font-weight-semibold">Loss</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if matchPlayer.eloChange > 0 %}
                                <span class="text-success">+{{ matchPlayer.eloChange }}</span>
                            {% elseif matchPlayer.eloChange < 0 %}
                                <span class="text-danger">{{ matchPlayer.eloChange }}</span>
                            {% else %}
                                <span>-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<script>
// ELO Rating History Chart
{% if chartData|length > 1 %}
const eloCtx = document.getElementById('eloChart').getContext('2d');
const eloData = {{ chartData|json_encode|raw }};

new Chart(eloCtx, {
    type: 'line',
    data: {
        labels: eloData.map(d => d.date),
        datasets: [{
            label: 'ELO Rating',
            data: eloData.map(d => d.elo),
            borderColor: '#6366f1',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#6366f1',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false
        },
        plugins: {
            legend: {
                labels: { color: '#fff' }
            }
        },
        scales: {
            x: {
                ticks: { color: 'rgba(255,255,255,0.6)' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: {
                ticks: { color: 'rgba(255,255,255,0.6)' },
                grid: { color: 'rgba(255,255,255,0.1)' },
                title: { display: true, text: 'ELO Rating', color: '#fff' }
            }
        }
    }
});
{% endif %}

// Performance Trends Chart
fetch('{{ path('app_analytics_trends', {'playerId': player.id}) }}?game={{ game.id }}')
    .then(response => response.json())
    .then(data => {
        const trendsContainer = document.getElementById('trendsChartContainer');
        const noDataMsg = document.getElementById('trendsNoData');
        
        if (!data.trends || data.trends.length === 0) {
            trendsContainer.style.display = 'none';
            noDataMsg.style.display = 'block';
            return;
        }
        
        const trendsCtx = document.getElementById('trendsChart').getContext('2d');
        
        new Chart(trendsCtx, {
            type: 'bar',
            data: {
                labels: data.trends.map(t => 'Week ' + t.week.split('-')[1]),
                datasets: [{
                    label: 'Kills',
                    data: data.trends.map(t => t.kills),
                    backgroundColor: '#ef4444',
                    borderRadius: 4
                }, {
                    label: 'Deaths',
                    data: data.trends.map(t => t.deaths),
                    backgroundColor: '#6366f1',
                    borderRadius: 4
                }, {
                    label: 'Assists',
                    data: data.trends.map(t => t.assists),
                    backgroundColor: '#34d399',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#fff' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: 'rgba(255,255,255,0.6)' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: {
                        ticks: { color: 'rgba(255,255,255,0.6)' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Error loading trends:', error);
        document.getElementById('trendsChartContainer').style.display = 'none';
        document.getElementById('trendsNoData').style.display = 'block';
    });
</script>
{% endblock %}

