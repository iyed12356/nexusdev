{% extends 'base.html.twig' %}

{% block title %}{{ player.nickname }} - Player Profile{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
.player-profile { background: #0d0d0d; color: #fff; min-height: 100vh; padding: 20px 0; }
.player-header { background: linear-gradient(135deg, #1a1a2e 0%, #0d0d0d 100%); border-radius: 12px; padding: 30px; margin-bottom: 20px; display: flex; gap: 30px; align-items: center; }
.player-image { width: 200px; height: 200px; border-radius: 8px; object-fit: cover; border: 3px solid #4a9eff; }
.player-info h1 { font-size: 2.5rem; font-weight: 700; margin: 0 0 10px 0; text-transform: uppercase; }
.player-meta { color: #888; font-size: 0.9rem; margin-bottom: 20px; }
.stat-bars { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
.stat-bar { display: flex; align-items: center; gap: 10px; }
.stat-bar label { width: 60px; font-size: 0.8rem; color: #888; text-transform: uppercase; }
.stat-bar .bar { flex: 1; height: 8px; background: #2a2a3e; border-radius: 4px; overflow: hidden; }
.stat-bar .bar-fill { height: 100%; background: linear-gradient(90deg, #4a9eff, #6b5ce7); border-radius: 4px; }
.stat-bar .value { width: 40px; text-align: right; font-weight: 600; color: #4a9eff; }
.section-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
.section-card { background: #1a1a2e; border-radius: 8px; padding: 15px; }
.section-card h4 { font-size: 0.75rem; text-transform: uppercase; color: #888; margin: 0 0 10px 0; }
.metrics-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px; }
.metric-card { background: #1a1a2e; border-radius: 8px; padding: 20px; }
.metric-card h3 { font-size: 0.9rem; text-transform: uppercase; margin: 0 0 15px 0; }
.rank-badge { display: inline-block; padding: 5px 15px; background: linear-gradient(135deg, #4a9eff, #6b5ce7); border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.pro-badge { display: inline-block; padding: 3px 10px; background: gold; color: #000; border-radius: 15px; font-size: 0.7rem; font-weight: 700; margin-left: 10px; }

/* Riot Rank Styles */
.riot-rank-card { 
    background: linear-gradient(135deg, #1a1a2e 0%, #0d0d0d 100%); 
    border-radius: 12px; 
    padding: 20px; 
    border: 2px solid; 
    margin-bottom: 20px;
}
.riot-rank-card.iron { border-color: #7f8c8d; }
.riot-rank-card.bronze { border-color: #cd7f32; }
.riot-rank-card.silver { border-color: #c0c0c0; }
.riot-rank-card.gold { border-color: #ffd700; }
.riot-rank-card.platinum { border-color: #2ecc71; }
.riot-rank-card.diamond { border-color: #3498db; }
.riot-rank-card.master { border-color: #9b59b6; }
.riot-rank-card.grandmaster { border-color: #ff4d4d; }
.riot-rank-card.challenger { border-color: #f8c537; }

.rank-display { display: flex; align-items: center; gap: 20px; }
.rank-icon { width: 80px; height: 80px; }
.rank-info h2 { margin: 0; font-size: 1.8rem; text-transform: uppercase; }
.rank-info .lp { font-size: 1.2rem; color: #888; }

.match-history { margin-top: 20px; }
.match-item { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    padding: 10px 15px; 
    background: #2a2a3e; 
    border-radius: 8px; 
    margin-bottom: 8px;
}
.match-item.win { border-left: 4px solid #2ed573; }
.match-item.loss { border-left: 4px solid #ff4757; }
.match-result { font-weight: bold; text-transform: uppercase; }
.match-result.win { color: #2ed573; }
.match-result.loss { color: #ff4757; }
.match-kda { color: #888; font-size: 0.9rem; }
</style>
{% endblock %}

{% block body %}
<div class="player-profile">
    <div class="container">
        <div class="player-header">
            <div style="position: relative;">
                {% if player.profilePicture %}
                    <img src="{{ asset('uploads/logos/' ~ player.profilePicture) }}" alt="{{ player.nickname }}" class="player-image">
                {% else %}
                    <div class="player-image" style="display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #2a2a3e, #1a1a2e); font-size: 4rem; border: 3px solid #4a9eff;">
                        {% if player.user and player.user.riotSummonerName %}
                            <img src="https://ddragon.leagueoflegends.com/cdn/13.24.1/img/profileicon/0.png" 
                                 alt="LoL Profile" 
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                        {% else %}
                            üéÆ
                        {% endif %}
                    </div>
                {% endif %}
                {% if isOwner %}
                <a href="{{ path('app_player_edit', {'id': player.id}) }}" 
                   style="position: absolute; bottom: -10px; right: -10px; background: #4a9eff; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 1.2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                   üì∑
                </a>
                {% endif %}
            </div>
            <div class="player-info" style="flex: 1;">
                <h1>{{ player.nickname }}</h1>
                <div class="player-meta">
                    {{ player.role|default('Player') }} 
                    {% if player.team %}| {{ player.team.name }}{% endif %}
                    {% if player.nationality %}| {{ player.nationality }}{% endif %}
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    {# Original player rank badge (from score) #}
                    <span class="rank-badge">{{ player.getRank() }}</span>
                    
                    {# Riot API rank badge #}
                    {% if statistic and statistic.rankTier %}
                        <span class="rank-badge" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                            üéÆ {{ statistic.rankTier }} {{ statistic.rankDivision }}
                        </span>
                    {% else %}
                        <span class="rank-badge" style="background: linear-gradient(135deg, #636e72, #b2bec3); opacity: 0.7;">
                            üéÆ API: Not Synced
                        </span>
                    {% endif %}
                    
                    {% if player.isPro %}<span class="pro-badge">PRO</span>{% endif %}
                </div>
                {% if statistic %}
                <div class="stat-bars">
                    <div class="stat-bar">
                        <label>Rating</label>
                        <div class="bar"><div class="bar-fill" style="width: {{ min(player.score/50, 100) }}%"></div></div>
                        <span class="value">{{ (player.score/100)|number_format(2) }}</span>
                    </div>
                    <div class="stat-bar">
                        <label>Win Rate</label>
                        <div class="bar"><div class="bar-fill" style="width: {{ statistic.winRate }}%"></div></div>
                        <span class="value">{{ statistic.winRate }}%</span>
                    </div>
                    <div class="stat-bar">
                        <label>K/D</label>
                        <div class="bar"><div class="bar-fill" style="width: {{ min((statistic.kills/max(statistic.deaths,1))*10, 100) }}%"></div></div>
                        <span class="value">{{ (statistic.kills/max(statistic.deaths,1))|number_format(2) }}</span>
                    </div>
                    <div class="stat-bar">
                        <label>Kills</label>
                        <div class="bar"><div class="bar-fill" style="width: {{ min(statistic.kills/10, 100) }}%"></div></div>
                        <span class="value">{{ statistic.kills }}</span>
                    </div>
                    <div class="stat-bar">
                        <label>Deaths</label>
                        <div class="bar"><div class="bar-fill" style="width: {{ min(statistic.deaths/10, 100) }}%; background: #ff4757;"></div></div>
                        <span class="value" style="color: #ff4757;">{{ statistic.deaths }}</span>
                    </div>
                    <div class="stat-bar">
                        <label>Assists</label>
                        <div class="bar"><div class="bar-fill" style="width: {{ min(statistic.assists/10, 100) }}%"></div></div>
                        <span class="value">{{ statistic.assists }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        {# Riot Rank Display Section #}
        {% if statistic and statistic.rankTier %}
        <div class="riot-rank-card {{ statistic.rankTier|lower }}">
            <div class="rank-display">
                <img src="https://opgg-static.akamaized.net/images/medals_new/{{ statistic.rankTier|lower }}.png" 
                     alt="{{ statistic.rankTier }}" 
                     class="rank-icon"
                     onerror="this.src='https://ddragon.leagueoflegends.com/cdn/13.24.1/img/profileicon/0.png'">
                <div class="rank-info">
                    <h2>{{ statistic.rankTier }} {{ statistic.rankDivision }}</h2>
                    <div class="lp">{{ statistic.leaguePoints }} LP</div>
                    <div style="margin-top: 5px; font-size: 0.85rem; color: #888;">
                        Wins: {{ statistic.wins }} | Losses: {{ statistic.losses }}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="section-grid">
            <div class="section-card">
                <h4>Matches</h4>
                <div style="font-size: 1.5rem; font-weight: 700;">{{ statistic ? statistic.matchesPlayed : 0 }}</div>
            </div>
            <div class="section-card">
                <h4>Wins</h4>
                <div style="font-size: 1.5rem; font-weight: 700; color: #2ed573;">{{ statistic ? statistic.wins : 0 }}</div>
            </div>
            <div class="section-card">
                <h4>Losses</h4>
                <div style="font-size: 1.5rem; font-weight: 700; color: #ff4757;">{{ statistic ? statistic.losses : 0 }}</div>
            </div>
            <div class="section-card">
                <h4>Score</h4>
                <div style="font-size: 1.5rem; font-weight: 700; color: #4a9eff;">{{ player.score }}</div>
            </div>
        </div>

        {# NEW: Riot API Rank Info Section #}
        {% if player.user and player.user.riotSummonerName %}
        <div class="metric-card" style="margin-top: 20px; border: 2px solid #4a9eff; background: linear-gradient(135deg, #1a1a2e 0%, #0d0d0d 100%);">
            <h3 style="color: #4a9eff; margin-bottom: 15px;">üéÆ Riot Games Rank (API)</h3>
            {% if statistic and statistic.rankTier %}
                <div style="display: flex; align-items: center; gap: 20px;">
                    <img src="https://opgg-static.akamaized.net/images/medals_new/{{ statistic.rankTier|lower }}.png" 
                         alt="{{ statistic.rankTier }}" 
                         style="width: 100px; height: 100px;"
                         onerror="this.src='https://ddragon.leagueoflegends.com/cdn/13.24.1/img/profileicon/0.png'">
                    <div>
                        <div style="font-size: 2rem; font-weight: 700; text-transform: uppercase; color: #fff;">
                            {{ statistic.rankTier }} {{ statistic.rankDivision }}
                        </div>
                        <div style="font-size: 1.2rem; color: #4a9eff; margin-top: 5px;">
                            {{ statistic.leaguePoints }} LP
                        </div>
                        <div style="font-size: 0.9rem; color: #888; margin-top: 5px;">
                            üë§ {{ player.user ? player.user.riotSummonerName : 'Unknown' }} | 
                            üèÜ Wins: {{ statistic.wins }} | 
                            ‚ùå Losses: {{ statistic.losses }}
                        </div>
                        {% if player.user and player.user.riotLastSyncAt %}
                        <div style="font-size: 0.8rem; color: #666; margin-top: 10px;">
                            üîÑ Last synced: {{ player.user.riotLastSyncAt|date('M d, Y H:i') }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div style="text-align: center; padding: 30px; color: #888;">
                    <p>No rank data from Riot API yet.</p>
                    <button onclick="syncRiotStats()" class="btn btn-primary" style="background: linear-gradient(135deg, #4a9eff, #6b5ce7); border: none; margin-top: 10px;">
                        üîÑ Fetch Rank from API
                    </button>
                </div>
            {% endif %}
        </div>
        {% endif %}

        {# Team Recruitment Section #}
        {% if isOwner %}
            {# Show pending invitations for this player #}
            {% if pendingInvitations|length > 0 %}
                <div class="metric-card" style="margin-top: 20px; border: 2px solid #ffc107;">
                    <h3 style="color: #ffc107;">üì¨ Team Invitations ({{ pendingInvitations|length }})</h3>
                    <p style="color: #888; margin-bottom: 1rem;">Teams want to recruit you!</p>
                    
                    {% for invitation in pendingInvitations|slice(0, 2) %}
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: #2a2a3e; border-radius: 8px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #ffc107, #ff9800); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">üèÜ</div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">{{ invitation.team.name }}</div>
                                <div style="font-size: 0.85rem; color: #888;">{{ invitation.team.game.name }}</div>
                                {% if invitation.message %}
                                    <div style="font-size: 0.8rem; color: #aaa; margin-top: 4px;">"{{ invitation.message|slice(0, 50) }}..."</div>
                                {% endif %}
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="respondToInvitation({{ invitation.id }}, 'accept')" class="btn btn-success btn-sm">‚úì</button>
                                <button onclick="respondToInvitation({{ invitation.id }}, 'decline')" class="btn btn-danger btn-sm">‚úï</button>
                            </div>
                        </div>
                    {% endfor %}
                    
                    {% if pendingInvitations|length > 2 %}
                        <a href="{{ path('app_player_invitations') }}" class="btn btn-outline-warning w-100">
                            View All {{ pendingInvitations|length }} Invitations ‚Üí
                        </a>
                    {% endif %}
                </div>
            {% endif %}

            {# Show recruit button if player is in a team #}
            {% if player.team %}
                <div class="metric-card" style="margin-top: 20px; border: 2px solid #2ecc71;">
                    <h3 style="color: #2ecc71;">üë• Team Management</h3>
                    <p style="color: #888; margin-bottom: 1rem;">You are a member of <strong>{{ player.team.name }}</strong></p>
                    <a href="{{ path('app_team_browse_players') }}" class="btn btn-success w-100">
                        üîç Find & Recruit Players
                    </a>
                </div>
            {% else %}
                <div class="metric-card" style="margin-top: 20px; border: 2px solid #3498db;">
                    <h3 style="color: #3498db;">üë• Looking for a Team?</h3>
                    <p style="color: #888; margin-bottom: 1rem;">You are currently a free agent. Teams may send you invitations!</p>
                    <div class="d-flex gap-2">
                        <a href="{{ path('app_leaderboard_index') }}" class="btn btn-primary" style="background: linear-gradient(135deg, #4a9eff, #6b5ce7); border: none;">
                            üèÜ View Leaderboard
                        </a>
                        <a href="{{ path('front_team_index') }}" class="btn btn-outline-light">
                            üîç Browse Teams
                        </a>
                    </div>
                </div>
            {% endif %}
        {% endif %}

        <div class="metrics-grid">
            <div class="metric-card">
                <h3>Performance Stats</h3>
                <table class="table" style="color: #fff; font-size: 0.9rem;">
                    <tr><td style="color: #888;">Game</td><td style="text-align: right; font-weight: 600;">{{ player.game.name }}</td></tr>
                    <tr><td style="color: #888;">Team</td><td style="text-align: right; font-weight: 600;">{{ player.team ? player.team.name : 'Free Agent' }}</td></tr>
                    <tr><td style="color: #888;">Role</td><td style="text-align: right; font-weight: 600;">{{ player.role|default('Not set') }}</td></tr>
                    <tr><td style="color: #888;">Kills/Game</td><td style="text-align: right; font-weight: 600;">{{ statistic ? (statistic.kills/max(statistic.matchesPlayed,1))|number_format(1) : '0.0' }}</td></tr>
                    <tr><td style="color: #888;">Deaths/Game</td><td style="text-align: right; font-weight: 600;">{{ statistic ? (statistic.deaths/max(statistic.matchesPlayed,1))|number_format(1) : '0.0' }}</td></tr>
                </table>
            </div>
            <div class="metric-card">
                <h3>Win Rate</h3>
                {% if statistic and statistic.matchesPlayed > 0 %}
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 3rem; font-weight: 700; color: #4a9eff;">{{ statistic.winRate }}%</div>
                        <div style="color: #888; font-size: 0.8rem;">WIN RATE</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                        <div style="text-align: center;"><div style="color: #2ed573; font-weight: 600;">{{ statistic.wins }}</div><div style="font-size: 0.7rem; color: #888;">WINS</div></div>
                        <div style="text-align: center;"><div style="color: #ff4757; font-weight: 600;">{{ statistic.losses }}</div><div style="font-size: 0.7rem; color: #888;">LOSSES</div></div>
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 40px 0; color: #888;">No matches</div>
                {% endif %}
            </div>
        </div>

        {# Match History Section - Last 2 Games #}
        {% if player.user and player.user.recentMatches and player.user.recentMatches|length > 0 %}
        <div class="metric-card" style="margin-top: 20px;">
            <h3>üìä Last 2 Games</h3>
            <div class="match-history">
                {% for match in player.user.recentMatches %}
                <div class="match-item {{ match.win ? 'win' : 'loss' }}">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <img src="https://ddragon.leagueoflegends.com/cdn/13.24.1/img/champion/{{ match.championName }}.png" 
                             alt="{{ match.championName }}" 
                             style="width: 40px; height: 40px; border-radius: 50%;"
                             onerror="this.src='https://ddragon.leagueoflegends.com/cdn/13.24.1/img/profileicon/0.png'">
                        <div>
                            <span class="match-result {{ match.win ? 'win' : 'loss' }}">{{ match.win ? 'Victory' : 'Defeat' }}</span>
                            <span style="color: #888; margin-left: 10px; font-size: 0.85rem;">Ranked Solo</span>
                        </div>
                    </div>
                    <div class="match-kda">
                        {{ match.kills }}/{{ match.deaths }}/{{ match.assists }} 
                        {% set kda = match.deaths > 0 ? ((match.kills + match.assists) / match.deaths) : (match.kills + match.assists) %}
                        <span style="color: {{ kda >= 4 ? '#4a9eff' : (kda >= 2 ? '#2ecc71' : '#888') }};">{{ kda|number_format(2) }} KDA</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            <p style="color: #666; font-size: 0.8rem; margin-top: 10px; text-align: center;">Real data from Riot Games API</p>
        </div>
        {% elseif statistic and statistic.matchesPlayed > 0 %}
        <div class="metric-card" style="margin-top: 20px;">
            <h3>üìä Match Statistics</h3>
            <p style="color: #888; text-align: center; padding: 20px;">Click "üîÑ Sync Stats Now" to fetch your last 2 games from Riot API</p>
        </div>
        {% endif %}

        {% if isOwner and not player.isPro %}
        <div class="metric-card" style="margin-top: 20px;">
            <h3>Become PRO</h3>
            <p style="color: #888; font-size: 0.9rem;">
                Take a short skill test to try to become a PRO player.
                If you don‚Äôt reach 100 points yet, you can book a coaching session or watch coaching guides to improve.
            </p>
            <div class="d-flex gap-2 flex-wrap">
                <a href="{{ path('app_player_pro_test', {'id': player.id}) }}" class="btn btn-primary" style="background: linear-gradient(135deg, #4a9eff, #6b5ce7); border: none;">
                    Take PRO Test
                </a>
                <a href="{{ path('front_coaching_new', {'id': player.id}) }}" class="btn btn-outline-light">
                    Book Coaching Session
                </a>
                <a href="{{ path('front_content_index') }}" class="btn btn-outline-light">
                    View Coaching Guides
                </a>
            </div>
        </div>
        {% endif %}
        {% if isOwner %}
        {# Riot Games Sync Section #}
        <div class="metric-card" style="margin-top: 20px;">
            <h3>üéÆ Riot Games Sync</h3>
            {% if player.user and player.user.riotSummonerName %}
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: #2a2a3e; border-radius: 8px;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #4a9eff, #6b5ce7); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">‚öîÔ∏è</div>
                    <div>
                        <div style="font-weight: bold;">{{ player.user.riotSummonerName }}</div>
                        <div style="font-size: 0.85rem; color: #888;">Region: {{ player.user.riotRegion|upper|default('EUW') }}</div>
                    </div>
                </div>
                {% if player.user.riotLastSyncAt %}
                    <div style="font-size: 0.8rem; color: #888; margin-bottom: 1rem;">
                        üîÑ Last synced: {{ player.user.riotLastSyncAt|date('M d, Y H:i') }}
                    </div>
                {% endif %}
                <div class="d-flex gap-2">
                    <button onclick="syncRiotStats()" class="btn btn-primary" id="syncBtn" style="background: linear-gradient(135deg, #4a9eff, #6b5ce7); border: none;">
                        üîÑ Sync Stats Now
                    </button>
                    <a href="{{ path('app_player_edit', {'id': player.id}) }}" class="btn btn-outline-light">
                        ‚úèÔ∏è Change Account
                    </a>
                </div>
                <p style="color: #888; font-size: 0.8rem; margin-top: 0.5rem;">Fetches your real LoL rank, LP, wins/losses, and KDA from Riot Games API</p>
            {% else %}
                <p style="color: #888; margin-bottom: 1rem;">Link your League of Legends account to automatically sync your rank and stats.</p>
                <a href="{{ path('app_player_edit', {'id': player.id}) }}" class="btn btn-primary" style="background: linear-gradient(135deg, #4a9eff, #6b5ce7); border: none;">
                    ‚ûï Add Riot Account
                </a>
            {% endif %}
        </div>
        
        <div class="metric-card" style="margin-top: 20px;">
            <h3>Update Statistics Manually</h3>
            <form method="post" action="{{ path('app_player_classify', {'id': player.id}) }}" class="row g-3">
                <div class="col-md-2"><input type="number" name="wins" class="form-control" placeholder="Wins" min="0" required style="background: #2a2a3e; border: none; color: #fff;"></div>
                <div class="col-md-2"><input type="number" name="losses" class="form-control" placeholder="Losses" min="0" required style="background: #2a2a3e; border: none; color: #fff;"></div>
                <div class="col-md-2"><input type="number" name="kills" class="form-control" placeholder="Kills" min="0" required style="background: #2a2a3e; border: none; color: #fff;"></div>
                <div class="col-md-2"><input type="number" name="deaths" class="form-control" placeholder="Deaths" min="0" required style="background: #2a2a3e; border: none; color: #fff;"></div>
                <div class="col-md-2"><input type="number" name="assists" class="form-control" placeholder="Assists" min="0" required style="background: #2a2a3e; border: none; color: #fff;"></div>
                <div class="col-md-2"><button type="submit" class="btn btn-primary w-100" style="background: linear-gradient(135deg, #4a9eff, #6b5ce7); border: none;">Update</button></div>
            </form>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
function respondToInvitation(invitationId, action) {
    const confirmMessage = action === 'accept' 
        ? 'Are you sure you want to join this team?' 
        : 'Are you sure you want to decline this invitation?';

    if (!confirm(confirmMessage)) {
        return;
    }

    fetch('{{ path('app_team_invitation_respond', {'invitationId': 'INVITATION_ID'}) }}'.replace('INVITATION_ID', invitationId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: 'action=' + action
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const toast = document.createElement('div');
            toast.className = 'alert alert-' + (action === 'accept' ? 'success' : 'info') + ' position-fixed top-0 end-0 m-3';
            toast.style.zIndex = '9999';
            toast.innerHTML = data.message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
                if (data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    location.reload();
                }
            }, 1500);
        } else {
            alert(data.error || 'An error occurred');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}

function syncRiotStats() {
    const btn = document.getElementById('syncBtn');
    btn.disabled = true;
    btn.innerHTML = 'üîÑ Syncing...';
    
    // Get CSRF token from meta tag if available
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
    
    fetch('/player/riot/sync-stats', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(async response => {
        const text = await response.text();
        try {
            return JSON.parse(text);
        } catch (e) {
            console.error('Invalid JSON response:', text.substring(0, 200));
            throw new Error('Server returned invalid response. Check if you are logged in.');
        }
    })
    .then(data => {
        console.log('Sync response:', data);
        if (data.success) {
            btn.innerHTML = '‚úÖ Synced! ' + (data.rank || '');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            btn.disabled = false;
            btn.innerHTML = 'üîÑ Sync Stats Now';
            let errorMsg = data.error || 'Failed to sync stats';
            if (data.debug) {
                errorMsg += '\n\nDebug: ' + JSON.stringify(data.debug, null, 2);
            }
            alert('Error: ' + errorMsg);
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = 'üîÑ Sync Stats Now';
        alert('Error: ' + error.message);
    });
}
</script>
{% endblock %}
